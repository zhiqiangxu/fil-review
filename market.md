# Market

The overall process is:
1. The provider and client need to ensure they have enough escrow balance in the market.
    1. Call [`add_balance`](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/lib.rs#L111) to increase the balance, [`withdraw_balance`](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/lib.rs#L136) to decrease the balance.
2. The client first signs a [`ClientDealProposal`](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/deal.rs#L130) after choosing a provider, then send the `ClientDealProposal` to the chosen provider.
3. If the provider also aggrees with the `ClientDealProposal`, the provider then calls `publish_storage_deals` to actually publish the storage deals.
    1. The provider can collect multiple `ClientDealProposal`s and publish them in batch.
    2. After `ClientDealProposal` is [validated](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/lib.rs#L246), the market [locks up](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/lib.rs#L435) `client_collateral` and `storage_fee` from the client, and `provider_collateral` from the provider.
    3. The deal is then scheduled for future processing. The exact epoch to process this deal is calculated by [`next_update_epoch`](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/lib.rs#L1149-L1154), which returns the closest epoch that is a multiple of `Policy.deal_updates_interval`, and not before the `start_epoch` of the proposal.
4. Later when the provider finishes sealing the sector, the included deals will then be activated, i.e., payment schedule will begin at the scheduled epoch for this deal.
5. If the sector is terminated before the agreed upon [`DealProposal.end_epoch`](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/deal.rs#L108), the `DealState.slash_epoch` will be [set](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/lib.rs#L656-L676) to the terminating epoch, and the provider will be slashed later at the scheduled epoch for this deal.
6. At the scheduled epoch, [`cron_tick`](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/lib.rs#L705) will  actually process this deal. There's 4 possible cases:
    1. The deal is still [not activated](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/lib.rs#L726-L767), the provider is slashed, and the locked up balance from the client is unlocked. The deal is then deleted from the blockchain and **never** processed again.
    2. The deal is terminated, the provider is slashed, the `storage_fee` is settled until the `DealState.slash_epoch`, based on the formula `storage_price_per_epoch * num_epochs_elapsed`. The deal is then deleted from the blockchain and **never** processed again.
    3. The deal [expires](https://github.com/filecoin-project/builtin-actors/blob/f28bfd0339ea51479efc5697eefffaddf5e9c244/actors/market/src/state.rs#L665-L668) normally, the `storage_fee` is settled until the `DealProposal.end_epoch`, the locked up `client_collateral` and `provider_collateral` are unlocked. The deal is then deleted from the blockchain and **never** processed again. 
    4. Otherwise, the `storage_fee` is settled until current epoch, and the next epoch to be processed again is `Policy.deal_updates_interval` epochs later.